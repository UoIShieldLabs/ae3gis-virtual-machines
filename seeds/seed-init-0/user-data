ssh_pwauth: true

users:
  - name: gns3
    groups: [sudo]
    shell: /bin/bash
    sudo: 'ALL=(ALL) NOPASSWD:ALL'
    lock_passwd: false

chpasswd:
  list: |
    gns3:gns3
  expire: false

package_update: true
packages:
  - python3
  - python3-pip
  - git
  - ufw
  - iproute2
  - net-tools
  - curl

write_files:
  - path: /home/gns3/.config/GNS3/gns3_server.conf
    owner: gns3:gns3
    permissions: '0644'
    content: |
      [Server]
      host = 0.0.0.0
      port = 3080
      auth = True
      user = gns3
      password = gns3
      projects_path = /home/gns3/projects

bootcmd:
  # 1. Create the Netplan configuration file with the static IP
  - echo "network:
      version: 2
      ethernets:
          enp0s1:
              dhcp4: false
              addresses:
                  - 172.29.191.111/18
              gateway4: 172.29.128.1
              nameservers:
                  addresses: [172.29.128.1, 8.8.8.8]" | sudo tee /etc/netplan/01-static-net.yaml > /dev/null

  # 2. Delete the default cloud-init Netplan file (if it exists)
  - sudo rm -f /etc/netplan/50-cloud-init.yaml

  # 3. Apply the new static configuration (must be run early)
  - sudo netplan apply
  - sudo rm -f /etc/machine-id
  - sudo rm -f /var/lib/dbus/machine-id  # Also important for D-Bus
  - sudo systemd-machine-id-setup       # Generates new ID
  - sudo reboot

runcmd:
  # base folders
  - 'su - gns3 -c "mkdir -p /home/gns3/projects /home/gns3/.config/GNS3"'

  # clone official repo
  - 'git clone https://github.com/GNS3/gns3-server.git /opt/gns3-server || true'
  - 'chown -R gns3:gns3 /opt/gns3-server'

  # install python deps + gns3server (to ~/.local for user gns3)
  - 'su - gns3 -c "python3 -m pip install --user -r /opt/gns3-server/requirements.txt"'
  - 'su - gns3 -c "cd /opt/gns3-server && python3 setup.py install --user"'

  # install systemd unit from repo
  - 'cp /opt/gns3-server/resources/systemd/gns3.service /etc/systemd/system/gns3server.service'

  # enable + start service
  - 'systemctl daemon-reload'
  - 'systemctl enable --now gns3server.service'

  # firewall (optional; keep if students connect over a trusted segment/VPN)
  - 'ufw allow 3080/tcp || true'
  - 'yes | ufw enable || true'
